--- 
- 
  connection: local
  hosts: localhost
  name: "ansible create EC2"
  tags: provisioning
  tasks: 
    - 
      local_action: 
        description: "Security Group for Newly Created EC2 Instance"
        module: ec2_group
        name: "{{ security_group }}"
        region: "{{ region }}"
        rules: 
          - 
            cidr_ip: 0.0.0.0/0
            from_port: 22
            proto: tcp
            to_port: 22
          - 
            cidr_ip: 0.0.0.0/0
            from_port: 80
            proto: tcp
            to_port: 80
        rules_egress: 
          - 
            cidr_ip: 0.0.0.0/0
            proto: all
      name: "build EC2"
    - 
      Name: "Test Deployment"
      app: test-deployment
      instance_tags: ~
      local_action: "ec2 group={{ security_group }} instance_type={{ instance_type}} image={{ image }} wait=true region={{ region }} keypair={{ keypair }} count={{count}}"
      name: "Launch the new t2 micro EC2 Instance"
      register: ec2
      version: "{{ build_number }}"
    - 
      ec2_instance_facts: 
        filters: 
          instance-state-name: running
          ? "tag:Name"
          : "Test Deployment"
          ? "tag:app"
          : test-deployment
      name: "ansible filter EC2 by label"
      register: ec2_facts
    - 
      local_action: "wait_for host={{ item.public_ip }} port=22 state=started"
      name: "Wait for EC2 Instance to Spin-up and ready for SSH access"
      with_items: "{{ ec2.instances }}"
    - 
      name: "Filter EC2 instances"
      set_fact: 
        ec2_instances: |
            {% set instances = [] %}
            {% for item in ec2_facts.instances if item.tags.version != build_number -%}
              {{ instances.append(item.instance_id) }}
            {%- endfor %}
            {{ instances }}
    - 
      ec2: 
        instance_ids: "{{ item }}"
        region: "{{ aws_region }}"
        state: absent
      name: "Terminate EC2 server"
      with_items: "{{ ec2_instances }}"
  vars: 
    build_number: "{{ lookup('env','BUILD_NUMBER') }}"
    count: 1
    ec2_current_tag: 
      build_number: "{{ build_number }}"
    ec2_tags: 
      Name: "Test Deployment"
      app: test-deployment
    image: ami-0b898040803850657
    instance_type: t2.micro
    keypair: Wilson-Test-EC2KeyPair
    region: us-east-1
    security_group: wilson-test-WebDMZ
